# ðŸ›¡ï¸ IronClad AI â€” TCPA-Compliant SMS Qualification Scripts & n8n Workflow Logic

**Goal:** Capture and qualify missed calls via SMS, ensuring TCPA compliance.  
**Tone:** Direct, helpful, professional, on-brand.  
**Compliance:** All messages include opt-out language. Call recording disclosure handled at the voice level.

---

## **SMS Qualification Flow**

### **Scenario:** Inbound Call Missed (After-Hours / Busy Line)

**Trigger:** Twilio webhook `workflow.missed_call` event.

**N8n Workflow Logic:**
1. **Twilio Trigger Node:** Listens for `workflow.missed_call` event.
2. **Conditional Node (Time Check):** If `current_time` is `after_hours` (e.g., 5 PM - 8 AM local time) OR `during_business_hours` AND `call_queue_full`.
3. **AI Qualification Node (OpenAI/Gemini):**  
   - **Input:** `caller_phone_number`, `business_name` (from SSOT).
   - **Output:** `initial_sms_message` (generated by AI, or use template).
4. **Twilio Send SMS Node:** Sends `initial_sms_message` to `caller_phone_number`.

---

### **SMS 1: Initial Missed Call Text (Sent within 10 seconds)**

**Sender:** [Your Business Name] (e.g., Standard Heating)

**Message:**
> Hey! We saw you called [Your Business Name]. We missed you! What can we help with today? Reply STOP to opt out.

**N8n Workflow Logic:**
1. **Twilio Webhook Node:** Listens for incoming SMS replies from the customer.
2. **AI Qualification Node (OpenAI/Gemini):**
   - **Input:** `customer_reply_text`.
   - **Prompt:** "Analyze this customer reply for [Your Business Name]. Identify if it's an emergency (e.g., 'no heat', 'water leak'), a service request ('AC not cooling', 'furnace check'), or a general inquiry. Extract key details like service needed, urgency, and any contact info. If it's an opt-out ('STOP'), flag it. Generate a concise, helpful follow-up SMS. If it's an emergency, suggest immediate booking. If it's a service request, ask for preferred time/date. If general, offer to call back. Ensure all messages are polite and include 'Reply STOP to opt out'."
   - **Output:** `qualification_status` (Emergency/Service/General/Opt-Out), `extracted_details`, `follow_up_sms_message`.
3. **Conditional Node (Qualification Status):** Branches based on `qualification_status`.

---

### **SMS 2: Emergency / Urgent Service Request**

**Trigger:** Customer reply indicates emergency (e.g., "no heat," "water leak").

**Sender:** [Your Business Name]

**Message:**
> Thanks! That sounds urgent. We can book a technician for you immediately. What's your full address and best time for arrival? Reply STOP to opt out.

**N8n Workflow Logic (Emergency Branch):**
1. **AI Qualification Node (OpenAI/Gemini):** Processes customer's address/time.
2. **Calendar Booking Node (Google Calendar/Outlook):** Creates a new appointment with `extracted_details`.
3. **Twilio Send SMS Node:** Confirms booking.
4. **Internal Notification Node (Slack/Email):** Notifies `dispatch_team` of emergency booking.

---

### **SMS 3: Standard Service Request**

**Trigger:** Customer reply indicates standard service (e.g., "AC not cooling," "furnace check").

**Sender:** [Your Business Name]

**Message:**
> Got it! We can help with that. What day and time works best for your service appointment? Reply STOP to opt out.

**N8n Workflow Logic (Service Branch):**
1. **AI Qualification Node (OpenAI/Gemini):** Processes customer's preferred time/date.
2. **Calendar Booking Node (Google Calendar/Outlook):** Suggests available slots or books directly.
3. **Twilio Send SMS Node:** Confirms booking.

---

### **SMS 4: General Inquiry / Offer to Call Back**

**Trigger:** Customer reply is general or unclear.

**Sender:** [Your Business Name]

**Message:**
> Thanks for reaching out! We'd be happy to help. Can we give you a call back at this number in the next 15 minutes? Reply STOP to opt out.

**N8n Workflow Logic (General Inquiry Branch):**
1. **Conditional Node:** If customer agrees to call back.
2. **Internal Notification Node (Slack/Email):** Notifies `sales_team` to call `caller_phone_number`.

---

### **SMS 5: Opt-Out Confirmation**

**Trigger:** Customer replies "STOP" (case-insensitive).

**Sender:** [Your Business Name]

**Message:**
> You have successfully unsubscribed from [Your Business Name] messages. You will no longer receive messages from this number. Reply START to resubscribe.

**N8n Workflow Logic (Opt-Out Branch):**
1. **Twilio Send SMS Node:** Sends opt-out confirmation.
2. **Database Update Node (Supabase):** Adds `caller_phone_number` to `suppression_list`.

---

## **TCPA Compliance Checklist (Integrated)**

- âœ… **Clear Opt-Out:** All outbound SMS messages include "Reply STOP to opt out."  
- âœ… **Suppression List:** An automated process (n8n + Supabase) maintains a suppression list for opted-out numbers.  
- âœ… **Call Recording Disclosure:** (Handled at the voice level by Twilio before call connection, as per SSOT).  
- âœ… **Consent:** Initial SMS is a direct response to an inbound call, implying consent for that interaction. For broader marketing, explicit consent must be obtained separately.  
- âœ… **Minnesota One-Party Consent:** (Minn. Stat. Â§ 626A.02(2)(d)) allows recording if one party consents, which IronClad ensures through disclosure.  

---

## **N8n Workflow Overview (High-Level)**

**Workflow Name:** `IronClad_MissedCall_Capture_and_Qualification`

**Nodes:**
- **Start:** Twilio Webhook (on `missed_call` event)
- **Branch 1: Initial SMS:**  
  - AI Node (OpenAI/Gemini) to generate initial message  
  - Twilio Send SMS  
- **Branch 2: Inbound SMS Reply:**  
  - Twilio Webhook (on `inbound_sms` event)  
  - AI Node (OpenAI/Gemini) for qualification and follow-up message generation  
  - Conditional Nodes (Emergency, Service, General, Opt-Out)  
  - **Emergency Sub-workflow:**  
    - AI Node for detail extraction  
    - Calendar Booking Node  
    - Twilio Send SMS (Confirmation)  
    - Slack/Email Notification  
  - **Service Sub-workflow:**  
    - AI Node for time/date  
    - Calendar Booking Node  
    - Twilio Send SMS (Confirmation)  
  - **General Sub-workflow:**  
    - Slack/Email Notification (Call Back Request)  
  - **Opt-Out Sub-workflow:**  
    - Twilio Send SMS (Opt-Out Confirmation)  
    - Supabase Update (Add to Suppression List)  

**Key Integrations:** Twilio, OpenAI/Gemini, Google Calendar/Outlook Calendar, Supabase, Slack/Email.

**END OF SMS SCRIPTS & N8N LOGIC**
